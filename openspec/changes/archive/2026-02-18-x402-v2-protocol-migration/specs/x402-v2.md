# X402 V2 Protocol Specification

## Overview
X402 is an HTTP payment protocol where servers respond with `402 Payment Required` and clients automatically sign EIP-3009 `transferWithAuthorization` payloads. The Coinbase X402 Go SDK handles the protocol negotiation transparently via an `http.RoundTripper` wrapper.

## Protocol Flow
1. Agent makes HTTP request via `x402_fetch` tool
2. Server returns 402 with `PAYMENT-REQUIRED` header (Base64 JSON)
3. SDK's `PaymentRoundTripper` intercepts the 402 response
4. SDK creates EIP-3009 authorization, signs with EIP-712 typed data
5. SDK retries request with `PAYMENT-SIGNATURE` header (Base64)
6. Server verifies signature, returns content with `PAYMENT-RESPONSE` header

## Components

### SignerProvider (`internal/x402/signer.go`)
- Interface: `SignerProvider` with `EvmSigner(ctx) (ClientEvmSigner, error)`
- Implementation: `LocalSignerProvider` loads key from SecretsStore
- Key material zeroed after signer creation

### Config (`internal/x402/types.go`)
- `Config` struct: Enabled, ChainID, MaxAutoPayAmount
- `CAIP2Network(chainID)` helper: converts `84532` â†’ `"eip155:84532"`

### Handler (`internal/x402/handler.go`)
- `NewX402Client()` creates SDK client with exact EVM scheme registered

### Interceptor (`internal/x402/interceptor.go`)
- Thread-safe lazy initialization of wrapped `*http.Client`
- `BeforePaymentCreationHook` enforces spending limits
- `HTTPClient(ctx)` returns the X402-wrapped HTTP client
- `IsEnabled()` and `SignerAddress()` for callers

### x402_fetch Tool (`internal/tools/payment/payment.go`)
- SafetyLevel: Dangerous (requires approval)
- Parameters: url (required), method, body, headers
- Uses interceptor's HTTPClient for automatic 402 handling
- Truncates response body at 8KB for agent context
- Records successful X402 payments for audit

### PaymentTx Schema (`internal/ent/schema/payment_tx.go`)
- New `payment_method` enum: `direct_transfer` (default) | `x402_v2`
- Distinguishes explicit transfers from X402 auto-payments

## Network Configuration
- Chain ID: numeric (e.g., 84532)
- CAIP-2 format: `eip155:<chainID>` (used by SDK)
- Supported: Any EVM chain with EIP-3009 USDC contract
