# P2P Trading Integration Test
# Spins up 3 Lango agents (Alice, Bob, Charlie) with a local Ethereum node (Anvil)
# to verify mDNS discovery, P2P handshake, and USDC token transfer end-to-end.

services:
  # Local Ethereum node (Foundry Anvil) â€” deterministic accounts, chainId 31337
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0", "--chain-id", "31337"]
    ports:
      - "8545:8545"
    networks:
      - p2p-net
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 30

  # One-shot setup: deploy MockUSDC and fund agent addresses
  setup:
    image: ghcr.io/foundry-rs/foundry:latest
    user: root
    depends_on:
      anvil:
        condition: service_healthy
    volumes:
      - ./contracts:/contracts:ro
      - ./scripts:/scripts:ro
      - shared:/shared
    entrypoint: ["sh", "/scripts/setup-anvil.sh"]
    networks:
      - p2p-net

  alice:
    image: lango:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    depends_on:
      setup:
        condition: service_completed_successfully
    environment:
      LANGO_CONFIG_FILE: /configs/alice.json
      LANGO_PASSPHRASE_FILE: /secrets/alice-passphrase.txt
      AGENT_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      AGENT_NAME: alice
    volumes:
      - ./configs:/configs:ro
      - ./secrets:/secrets:ro
      - ./docker-entrypoint-p2p.sh:/usr/local/bin/docker-entrypoint-p2p.sh:ro
      - shared:/shared:ro
    entrypoint: ["sh", "/usr/local/bin/docker-entrypoint-p2p.sh"]
    command: ["serve"]
    ports:
      - "18789:18789"
    networks:
      - p2p-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18789/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

  bob:
    image: lango:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    depends_on:
      setup:
        condition: service_completed_successfully
    environment:
      LANGO_CONFIG_FILE: /configs/bob.json
      LANGO_PASSPHRASE_FILE: /secrets/bob-passphrase.txt
      AGENT_PRIVATE_KEY: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
      AGENT_NAME: bob
    volumes:
      - ./configs:/configs:ro
      - ./secrets:/secrets:ro
      - ./docker-entrypoint-p2p.sh:/usr/local/bin/docker-entrypoint-p2p.sh:ro
      - shared:/shared:ro
    entrypoint: ["sh", "/usr/local/bin/docker-entrypoint-p2p.sh"]
    command: ["serve"]
    ports:
      - "18790:18790"
    networks:
      - p2p-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18790/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

  charlie:
    image: lango:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    depends_on:
      setup:
        condition: service_completed_successfully
    environment:
      LANGO_CONFIG_FILE: /configs/charlie.json
      LANGO_PASSPHRASE_FILE: /secrets/charlie-passphrase.txt
      AGENT_PRIVATE_KEY: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
      AGENT_NAME: charlie
    volumes:
      - ./configs:/configs:ro
      - ./secrets:/secrets:ro
      - ./docker-entrypoint-p2p.sh:/usr/local/bin/docker-entrypoint-p2p.sh:ro
      - shared:/shared:ro
    entrypoint: ["sh", "/usr/local/bin/docker-entrypoint-p2p.sh"]
    command: ["serve"]
    ports:
      - "18791:18791"
    networks:
      - p2p-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18791/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

volumes:
  shared:

networks:
  p2p-net:
    driver: bridge
