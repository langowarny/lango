services:
  lango:
    build: .
    image: lango:latest
    container_name: lango
    restart: unless-stopped
    ports:
      - "18789:18789"
    volumes:
      - lango-data:/data
    secrets:
      - lango_config
      - lango_passphrase
    environment:
      - LANGO_PROFILE=default
    profiles:
      - default
      - browser

  lango-browser:
    build:
      context: .
      args:
        WITH_BROWSER: "true"
    image: lango:browser
    container_name: lango-browser
    restart: unless-stopped
    ports:
      - "18789:18789"
    volumes:
      - lango-data:/data
    secrets:
      - lango_config
      - lango_passphrase
    environment:
      - LANGO_PROFILE=default
    profiles:
      - browser

  lango-sidecar:
    build: .
    image: lango:latest
    container_name: lango-sidecar
    restart: unless-stopped
    ports:
      - "18789:18789"
    volumes:
      - lango-data:/data
    secrets:
      - lango_config
      - lango_passphrase
    environment:
      - LANGO_PROFILE=default
      - ROD_BROWSER_WS=ws://chrome:9222
    depends_on:
      chrome:
        condition: service_healthy
    profiles:
      - browser-sidecar

  chrome:
    image: chromedp/headless-shell:latest
    container_name: lango-chrome
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9222/json/version || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    profiles:
      - browser-sidecar

secrets:
  lango_config:
    file: ./config.json
  lango_passphrase:
    file: ./passphrase.txt

volumes:
  lango-data:
